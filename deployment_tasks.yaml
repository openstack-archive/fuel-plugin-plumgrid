- id: PLUMgrid-Gateway
  type: group
  role: [PLUMgrid-Gateway]
  tasks: [hiera, globals, logging, tools, netconfig]
  required_for: [deploy_end]
  requires: [deploy_start]
  parameters:
    strategy:
      type: parallel

# Skip default neutron plugins
- id: primary-openstack-network-plugins-l2
  type: skipped
- id: openstack-network-plugins-l2
  type: skipped
- id: openstack-network-routers-ha
  type: skipped
- id: openstack-network-compute-nova
  type: skipped
# Skip Neutron agents
- id: primary-openstack-network-agents-l3
  type: skipped
- id: openstack-network-agents-l3
  type: skipped
- id: primary-openstack-network-agents-dhcp
  type: skipped
- id: openstack-network-agents-dhcp
  type: skipped
- id: primary-openstack-network-agents-metadata
  type: skipped
- id: openstack-network-agents-metadata
  type: skipped
- id: openstack-network-agents-sriov
  type: skipped
# Skip default fuel networks and routers
- id: openstack-network-networks
  type: skipped
- id: openstack-network-routers
  type: skipped

- id: disable-openvswitch
  groups: ['controller', 'compute', 'PLUMgrid-Gateway', 'primary-controller']
  required_for: [netconfig, deploy_end]
  requires: [deploy_start, globals]
  type: puppet
  reexecute_on:
  - deploy_changes
  parameters:
    puppet_manifest: puppet/manifests/disable_openvswitch.pp
    puppet_modules: puppet/modules:/etc/puppet/modules
    timeout: 120

- id: openstack-network-plumgrid-compute-nova
  groups: ['compute']
  required_for: [openstack-network-end]
  requires: [openstack-network-common-config]
  type: puppet
  parameters:
    puppet_manifest: puppet/manifests/plumgrid_nova_compute.pp
    puppet_modules: puppet/modules/:/etc/puppet/modules/
    timeout: 1440

- id: pgtools-support
  role: ['controller', 'primary-controller']
  required_for: [post_deployment_end]
  requires: [post_deployment_start]
  type: puppet
  parameters:
    puppet_manifest: puppet/manifests/tools.pp
    puppet_modules: puppet/modules:/etc/puppet/modules
    timeout: 3000

- id: check-pgzone
  role: ['controller', 'compute', 'PLUMgrid-Gateway', 'primary-controller']
  required_for: [post_deployment_end, pg_common]
  requires: [post_deployment_start]
  type: puppet
  parameters:
    puppet_manifest: puppet/manifests/pre_deployment.pp
    puppet_modules: puppet/modules:/etc/puppet/modules
    timeout: 720

- id: pg_common
  role: ['controller', 'compute', 'PLUMgrid-Gateway', 'primary-controller']
  required_for: [post_deployment_end, setup-director]
  requires: [post_deployment_start, check-pgzone, configure_default_route]
  type: puppet
  parameters:
    puppet_manifest: puppet/manifests/pg_common.pp
    puppet_modules: puppet/modules:/etc/puppet/modules
    timeout: 3000

- id: setup-director
  role: ['controller', 'primary-controller']
  required_for: [post_deployment_end, director-fixes]
  requires: [post_deployment_start, pg_common]
  type: puppet
  parameters:
    puppet_manifest: puppet/manifests/director.pp
    puppet_modules: puppet/modules:/etc/puppet/modules
    timeout: 3000

- id: director-fixes
  role: ['controller', 'primary-controller']
  required_for: [post_deployment_end, post_pg_license]
  requires: [post_deployment_start, setup-director]
  type: puppet
  parameters:
    puppet_manifest: puppet/manifests/director_fixes.pp
    puppet_modules: puppet/modules:/etc/puppet/modules
    timeout: 3000

- id: solution-api
  role: ['primary-controller']
  required_for: [post_deployment_end, setup-edge]
  requires: [post_deployment_start, post_pg_license]
  type: shell
  parameters:
    cmd: bash solution_api.sh
    timeout: 3000

- id: post_pg_license
  role: ['primary-controller']
  required_for: [post_deployment_end, solution-api]
  requires: [post_deployment_start, director-fixes]
  type: shell
  parameters:
    cmd: bash post_pg_license.sh
    timeout: 3000

- id: setup-edge
  role: ['compute']
  required_for: [post_deployment_end, setup-gateway]
  requires: [post_deployment_start, solution-api]
  type: puppet
  parameters:
    puppet_manifest: puppet/manifests/edge.pp
    puppet_modules: puppet/modules:/etc/puppet/modules
    timeout: 3000

- id: setup-gateway
  role: ['PLUMgrid-Gateway']
  required_for: [post_deployment_end]
  requires: [post_deployment_start, setup-edge]
  type: puppet
  parameters:
    puppet_manifest: puppet/manifests/gateway.pp
    puppet_modules: puppet/modules:/etc/puppet/modules
    timeout: 3000
